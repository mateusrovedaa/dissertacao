services:
  mqtt:
    image: eclipse-mosquitto:2
    container_name: mqtt
    restart: unless-stopped
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./certs:/mosquitto/certs:ro
    ports:
      - "1883:1883"
      - "8883:8883"
  db:
    image: postgres:17
    environment:
      POSTGRES_DB: vispac
      POSTGRES_USER: vispac
      POSTGRES_PASSWORD: vispac
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vispac -d vispac"]
      interval: 5s
      timeout: 5s
      retries: 10

  cloud:
    build:
      context: .
      target: cloud
    command: python cloud_api.py
    environment:
      CLOUD_DB_URL: postgresql://vispac:vispac@db:5432/vispac
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "9000:9000"
    volumes:
      - ./logs:/app/logs

  fog:
    build:
      context: .
      target: fog
    command: python news2_api.py
    environment:
      CLOUD_BASE_URL: http://cloud:9000
      MQTT_BROKER: mqtt
      MQTT_PORT: 8883
      MQTT_CA_CERT: /app/certs/ca.crt
    depends_on:
      - cloud
      - mqtt
    ports:
      - "8000:8000"
    volumes:
      - ./logs:/app/logs
      - ./certs/ca.crt:/app/certs/ca.crt:ro

  edge:
    build:
      context: .
      target: edge
    command: python vispac_edge_prototype.py
    environment:
      HIGH_PATIENTS: ${HIGH_PATIENTS:-2}   # Number of high-risk patients (random selection)
      LOW_PATIENTS: ${LOW_PATIENTS:-3}     # Number of low-risk patients (random selection)
      SCENARIO: ${SCENARIO:-scenario3_vispac}  # Test scenario
      API_URL: http://fog:8000/vispac/upload_batch
      EDGE_USE_MQTT: "1"
      MQTT_BROKER: mqtt
      MQTT_PORT: 8883
      MQTT_CA_CERT: /app/certs/ca.crt
    depends_on:
      - fog
      - mqtt
    volumes:
      - ./logs:/app/logs
      - ./certs/ca.crt:/app/certs/ca.crt:ro
